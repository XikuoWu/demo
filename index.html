<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»£ç ç¼–è¾‘å™¨</title>
    <noscript>æ‚¨éœ€è¦å¯ç”¨JavaScriptæ‰èƒ½ä½¿ç”¨æ­¤ç½‘ç«™</noscript>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@vscode/codicons@latest/dist/codicon.css">
    <link rel="shortcut icon" href="https://xikuowu.github.io/demo/favicon.ico" type="image/x-icon">
    <style>
        html {
            min-width: 1000px;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, Helvetica, sans-serif;
            font-weight: 100;
            height: calc(100vh - 33px);
            overflow: hidden;
        }
        header {
            background-color: black;
            color: white;
            display: flex;
            align-items: center;
            border-bottom: 0.3px white solid;
        }
        header div {
            display: inline-block;
            margin-left: 20px;
            font-size: larger;
            cursor: pointer;
            padding: 3px;
        }
        header div:hover {
            background-color: rgb(52, 52, 52);
        }
        header div:first-child {
            margin-left: 30px;
        }
        header span {
            color: rgb(191, 191, 191);
            font-size: small;
        }
        .container {
            display: flex;
        }
        #left-bar {
            background-color: rgb(27, 27, 27);
            height: 100%;
            width: 60px;
            overflow: hidden;
            border-right: 0.5px white solid;
            position: absolute;
        }
        #left-bar img {
            width: 45px;
            height: 45px;
            display: block;
            cursor: pointer;
            margin-left: 7px;
            margin-top: 5px;
        }
        #left-bar img:first-child {
            background-color: rgb(57, 57, 57);
            border-radius: 5px;
            margin-top: 20px;
        }
        #left-bar img:last-child {
            margin-top: 20px;
        }
        #left-bar img:last-child:hover {
            background-color: rgb(57, 57, 57);
            border-radius: 5px;
        }
        .content {
            width: calc(100% - 310px);
            height: 100%;
            position: absolute;
            left: 310px;
            top: 33px;
        }
        #editor-container {
            display: flex;
            width: 100%;
            height: 100%;
        }
        #editor {
            flex: 1;
            height: 100vh;
            margin-top: 0.3px;
        }
        #files {
            background-color: black;
            width: 250px;
            height: 100%;
            overflow-y: auto;
            margin-left: 60px;
            color: white;
        }
        #folder-name {
            color: white;
            text-align: center;
            padding: 5px;
            border-bottom: 0.1px white solid;
        }
        .alert {
            position: fixed;
            top: 33.3px;
            background-color: rgb(55, 55, 55);
            height: 100%;
            width: 100%;
            left: 310px;
            z-index: 100000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        p {
            margin: 0;
            padding: 5px;
        }
        .file,
        .folder {
            margin-left: 20px;
            cursor: pointer;
        }
        .folder:hover,
        .file:hover {
            color: lightgray;
        }
    </style>
</head>
<body>
    <header>
        <div id="open-folder">æ‰“å¼€æ–‡ä»¶å¤¹</div>
        <div id="close-folder">å…³é—­æ–‡ä»¶å¤¹</div>
        <div id="create-file">åˆ›å»ºæ–‡ä»¶</div>
        <div id="create-folder">åˆ›å»ºæ–‡ä»¶å¤¹</div>
        <div id="save">ä¿å­˜</div><span>(Ctrl+S)</span>
    </header>
    <div id="left-bar">
        <img src="https://xikuowu.github.io/demo/folder.png" alt="">
        <img class="terminal" src="https://xikuowu.github.io/demo/terminal.png" alt="">
    </div>
    <div id="files">
        <p id="folder-name">æ–‡ä»¶ç®¡ç†å™¨</p>
    </div>
    <div class="content">
        <div class="editor-container">
            <div id="editor"></div>
        </div>
    </div>
    <div class="alert">
        <img src="https://xikuowu.github.io/demo/favicon.ico" alt="">
    </div>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor/min/vs/loader.js"></script>
    <script>
        const al = document.querySelector('.alert');
        const saveButton = document.getElementById('save');
        if (!saveButton) {
            console.error('Save button not found');
        }


        // editor start
        require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor/min/vs' } });
        require(['vs/editor/editor.main'], function () {
            monaco.editor.create(document.getElementById('editor'), {
                value: "// Start coding here...\n",
                language: "javascript",
                theme: "vs-dark"
            });
        });
        // editor end
        // terminal start
        const ter = document.querySelector('.terminal');
        ter.addEventListener('click', function () {
            alert('æ— æ³•æ‰“å¼€ç»ˆç«¯');
        });
        // terminal end
        // æ·»åŠ æ”¯æŒçš„æ–‡ä»¶ç±»å‹åˆ—è¡¨
        const SUPPORTED_FILE_TYPES = [
            '.js', '.jsx', '.ts', '.tsx', '.html', '.htm', '.css',
            '.json', '.py', '.java', '.cpp', '.c', '.cs', '.php',
            '.rb', '.swift', '.go', '.rs', '.sql', '.sh', '.xml',
            '.yaml', '.yml', '.md'
        ];

        // ä¿®å¤è·å–æ–‡ä»¶æ‰©å±•åçš„å‡½æ•°
        function getFileExtension(filename) {
            const lastDotIndex = filename.lastIndexOf('.');
            if (lastDotIndex === -1) return ''; // å¦‚æœæ²¡æœ‰æ‰©å±•å
            return filename.slice(lastDotIndex).toLowerCase(); // åŒ…å«ç‚¹å·çš„æ‰©å±•å
        }

        // è®¾ç½®ç¼–è¾‘å™¨è¯­è¨€çš„å‡½æ•°
        function setEditorLanguage(filename) {
            const ext = getFileExtension(filename).slice(1); // ç§»é™¤ç‚¹å·
            const languageMap = {
                'js': 'javascript',
                'jsx': 'javascript',
                'ts': 'typescript',
                'tsx': 'typescript',
                'html': 'html',
                'htm': 'html',
                'css': 'css',
                'json': 'json',
                'py': 'python',
                'java': 'java',
                'cpp': 'cpp',
                'c': 'cpp',
                'cs': 'csharp',
                'php': 'php',
                'rb': 'ruby',
                'swift': 'swift',
                'go': 'go',
                'rs': 'rust',
                'sql': 'sql',
                'sh': 'shell',
                'xml': 'xml',
                'yaml': 'yaml',
                'yml': 'yaml',
                'md': 'markdown'
            };
            return languageMap[ext] || 'plaintext';
        }

        // ä¿®æ”¹æ–‡ä»¶ç‚¹å‡»äº‹ä»¶å¤„ç†éƒ¨åˆ†
        async function listFilesAndFolders(dirHandle, parentElement, indent = 0) {
            try {
                for await (const entry of dirHandle.values()) {
                    const itemContainer = document.createElement('div');
                    const itemElement = document.createElement('p');

                    itemElement.style.marginLeft = `${indent}px`;

                    if (entry.kind === 'directory') {
                        // æ–‡ä»¶å¤¹å¤„ç†ä»£ç ä¿æŒä¸å˜...
                        itemElement.className = 'folder';
                        itemElement.innerHTML = `ğŸ“ ${entry.name}`;
                        // ... å…¶ä½™æ–‡ä»¶å¤¹å¤„ç†ä»£ç  ...
                    } else {
                        itemElement.className = 'file';
                        itemElement.innerHTML = `ğŸ“„ ${entry.name}`;
                        itemContainer.appendChild(itemElement);

                        // ä¿®æ”¹åçš„æ–‡ä»¶ç‚¹å‡»äº‹ä»¶å¤„ç†
                        itemElement.addEventListener('click', async () => {
                            try {
                                const fileExtension = getFileExtension(entry.name);

                                if (SUPPORTED_FILE_TYPES.includes(fileExtension)) {
                                    // è·å–æ–‡ä»¶å¥æŸ„å¹¶ä¿å­˜åˆ°å…¨å±€å˜é‡
                                    currentFileHandle = await dirHandle.getFileHandle(entry.name);
                                    const file = await currentFileHandle.getFile();
                                    const content = await file.text();

                                    // è·å–ç¼–è¾‘å™¨å®ä¾‹å¹¶è®¾ç½®å†…å®¹
                                    const editor = monaco.editor.getModels()[0];
                                    editor.setValue(content);
                                    monaco.editor.setModelLanguage(editor, setEditorLanguage(entry.name));
                                    al.style.display = 'none';
                                } else {
                                    alert('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼');
                                }
                            } catch (error) {
                                console.error('Error reading file:', error);
                                alert('è¯»å–æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ï¼');
                            }
                        });
                    }

                    parentElement.appendChild(itemContainer);
                }
            } catch (error) {
                console.error('Error listing directory contents:', error);
            }
        }

        // å…¶ä½™ä»£ç ä¿æŒä¸å˜
        const openFolderButton = document.getElementById('open-folder');
        const closeFolderButton = document.getElementById('close-folder');
        const createFileButton = document.getElementById('create-file');
        const filesContainer = document.getElementById('files');
        const folderNameElement = document.getElementById('folder-name');

        function clearFileList() {
            folderNameElement.textContent = "æ–‡ä»¶ç®¡ç†å™¨";
            const existingFiles = filesContainer.querySelectorAll('div');
            existingFiles.forEach(element => element.remove());

            // é‡ç½®ç¼–è¾‘å™¨å†…å®¹å’Œè¯­è¨€
            const editor = monaco.editor.getModels()[0];
            editor.setValue("// Start coding here...\n");
            monaco.editor.setModelLanguage(editor, 'javascript');
            al.style.display = 'flex'
        }

        openFolderButton.addEventListener('click', async () => {
            try {
                const directoryHandle = await window.showDirectoryPicker();
                folderNameElement.textContent = directoryHandle.name;
                const existingFiles = filesContainer.querySelectorAll('div');
                existingFiles.forEach(element => element.remove());
                await listFilesAndFolders(directoryHandle, filesContainer);
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Error accessing folder:', error);
                }
            }
        });

        closeFolderButton.addEventListener('click', clearFileList);
        createFileButton.addEventListener('click', async () => {
            try {
                const directoryHandle = await window.showDirectoryPicker();
                const fileName = prompt("è¯·è¾“å…¥æ–‡ä»¶åï¼š");

                if (fileName) {
                    const fileHandle = await directoryHandle.getFileHandle(fileName, { create: true });
                    const writable = await fileHandle.createWritable();
                    await writable.write(""); // Write an empty content for now
                    await writable.close();
                    alert("æ–‡ä»¶åˆ›å»ºæˆåŠŸï¼");
                }
            } catch (error) {
                console.error('Error creating file:', error);
                alert("æ–‡ä»¶åˆ›å»ºå¤±è´¥ï¼");
            }
        });

        const createFolderButton = document.getElementById('create-folder');
        // åˆ›å»ºæ–‡ä»¶å¤¹åŠŸèƒ½
        createFolderButton.addEventListener('click', async () => {
            const directoryHandle = await window.showDirectoryPicker(); // æ‰“å¼€æ–‡ä»¶å¤¹é€‰æ‹©å¯¹è¯æ¡†

            // è®©ç”¨æˆ·è¾“å…¥æ–‡ä»¶å¤¹åç§°
            const folderName = prompt('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°:');
            if (folderName) {
                try {
                    // ä½¿ç”¨ File System Access API åˆ›å»ºæ–°æ–‡ä»¶å¤¹
                    await directoryHandle.getDirectoryHandle(folderName, { create: true });
                    alert('æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸï¼');
                    // å¯ä»¥é€‰æ‹©é‡æ–°åŠ è½½æ–‡ä»¶å¤¹åˆ—è¡¨ï¼Œæ›´æ–°ç•Œé¢
                    clearFileList();
                    await listFilesAndFolders(directoryHandle, filesContainer);
                } catch (error) {
                    console.error('åˆ›å»ºæ–‡ä»¶å¤¹æ—¶å‡ºé”™:', error);
                    alert('æ–‡ä»¶å¤¹åˆ›å»ºå¤±è´¥ï¼');
                }
            } else {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ–‡ä»¶å¤¹åç§°');
            }
        });

        let currentFileHandle = null;

        async function handleFileClick(fileHandle) {
            try {
                const file = await fileHandle.getFile();
                const content = await file.text();

                currentFileHandle = fileHandle; // æ›´æ–°å…¨å±€å¥æŸ„

                const editor = monaco.editor.getModels()[0];
                editor.setValue(content);
                monaco.editor.setModelLanguage(editor, setEditorLanguage(file.name));

                al.style.display = 'none';
            } catch (error) {
                console.error('Error reading file:', error);
                alert('è¯»å–æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ï¼');
            }
        }

        // ä¿®æ”¹ä¿å­˜æŒ‰é’®äº‹ä»¶å¤„ç†
        saveButton.addEventListener('click', async () => {
            if (currentFileHandle) {
                try {
                    const editor = monaco.editor.getModels()[0];
                    const content = editor.getValue();

                    // åˆ›å»ºå¯å†™æµå¹¶ä¿å­˜å†…å®¹
                    const writable = await currentFileHandle.createWritable();
                    await writable.write(content);
                    await writable.close();

                    alert('æ–‡ä»¶å·²ä¿å­˜æˆåŠŸï¼');
                } catch (error) {
                    console.error('ä¿å­˜æ–‡ä»¶æ—¶å‡ºé”™:', error);
                    alert('æ–‡ä»¶ä¿å­˜å¤±è´¥ï¼');
                }
            } else {
                alert('è¯·å…ˆæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼');
            }
        });

        // åœ¨æ¸…é™¤æ–‡ä»¶åˆ—è¡¨æ—¶é‡ç½® currentFileHandle
        function clearFileList() {
            folderNameElement.textContent = "æ–‡ä»¶ç®¡ç†å™¨";
            const existingFiles = filesContainer.querySelectorAll('div');
            existingFiles.forEach(element => element.remove());

            // é‡ç½®ç¼–è¾‘å™¨å†…å®¹å’Œè¯­è¨€
            const editor = monaco.editor.getModels()[0];
            editor.setValue("// Start coding here...\n");
            monaco.editor.setModelLanguage(editor, 'javascript');
            al.style.display = 'flex';
            
            // é‡ç½®å½“å‰æ–‡ä»¶å¥æŸ„
            currentFileHandle = null;
        }

        // é¦–å…ˆæå–ä¿å­˜åŠŸèƒ½ä¸ºå•ç‹¬çš„å‡½æ•°
        async function saveCurrentFile() {
            if (currentFileHandle) {
                try {
                    const editor = monaco.editor.getModels()[0];
                    const content = editor.getValue();

                    // åˆ›å»ºå¯å†™æµå¹¶ä¿å­˜å†…å®¹
                    const writable = await currentFileHandle.createWritable();
                    await writable.write(content);
                    await writable.close();

                    alert('æ–‡ä»¶å·²ä¿å­˜æˆåŠŸï¼');
                } catch (error) {
                    console.error('ä¿å­˜æ–‡ä»¶æ—¶å‡ºé”™:', error);
                    alert('æ–‡ä»¶ä¿å­˜å¤±è´¥ï¼');
                }
            } else {
                alert('è¯·å…ˆæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼');
            }
        }

        // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('keydown', async (e) => {
            // æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹ Ctrl+S (Windows) æˆ– Command+S (Mac)
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                // é˜»æ­¢æµè§ˆå™¨é»˜è®¤çš„ä¿å­˜è¡Œä¸º
                e.preventDefault();
                
                // è§¦å‘ä¿å­˜åŠŸèƒ½
                await saveCurrentFile();
            }
        });

        // ä¿å­˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶ä½¿ç”¨ç›¸åŒçš„ä¿å­˜å‡½æ•°
        saveButton.addEventListener('click', saveCurrentFile);
    </script>
</body>
</html>