<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coder</title>
  <link rel="shortcut icon" href="./favicon.ico" type="image/x-icon">
  <style>
    body {
      padding: 0;
      margin: 0;
      background-color: rgb(50, 50, 50);
      color: white;
    }

    header {
      background-color: black;
      height: 50px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    header button {
      margin: 5px;
      background-color: white;
      border: 0;
      border-radius: 5px;
      padding: 3px;
      font-size: 13px;
      cursor: pointer;
      color: black;
    }

    textarea {
      background-color: transparent;
      color: white;
      width: 100%;
      height: 100vh;
      padding: 10px;
      font-size: 16px;
      outline: none;
      resize: none;
      margin-top: 1.3px;
      border: 0.6px white solid;
      box-sizing: border-box;
    }

    .content div {
      border-top: white 0.6px solid;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      display: none;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      width: 300px;
    }

    .modal-content input {
      width: 220px;
      padding: 10px;
      font-size: 16px;
    }

    .modal-content button {
      padding: 10px 15px;
      margin: 5px;
      font-size: 14px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
    }

    .btn-confirm {
      background-color: #4caf50;
      color: white;
    }

    .btn-cancel {
      background-color: #f44336;
      color: white;
    }

    #file {
      display: flex;
      margin-top: 10px;
      border: 0;
      margin-left: 10px;
    }

    .file-item {
      background-color: rgb(33, 33, 33);
      margin: 5px;
      padding: 10px;
      cursor: pointer;
      border-radius: 5px;
      width: 100px;
      border-top: 0;
    }

    .file-item:hover {
      background-color: rgb(60, 60, 60);
    }
  </style>
</head>

<body>
  <header>
    <button id="save" style="background-color: rgb(212, 138, 86); display: none;">ä¿å­˜</button>
    <button id="createfile">åˆ›å»ºæ–‡ä»¶</button>
    <button id="start" style="background-color: rgb(212, 138, 86); display: none;">è¿è¡Œ</button>
    <button id="openfolder">æ‰“å¼€æ–‡ä»¶å¤¹</button>
  </header>

  <div class="content">
    <div style="height: 70px; width: 100%; background-color: rgb(33, 33, 33); display: flex; overflow: auto;">
      <button
        style="margin: 10px; font-size: 30px; background-color: white; border: 0.3px black solid; border-radius: 6px; cursor: pointer; "
        id="pre">ğŸ”™</button>
      <div
        style="border: 0; display: inline; font-size: larger; margin-left: 10px; margin-top: 20px; border-right: 0.3px white solid; padding: 5px;"
        id="foldername">
      </div>
      <div id="file"></div>
    </div>
    <textarea name="" id="coder"></textarea>
  </div>

  <div class="modal" id="modal">
    <div class="modal-content">
      <h3 style="color: black;">è¾“å…¥æ–‡ä»¶å</h3>
      <input type="text" id="filename" placeholder="è¾“å…¥æ–‡ä»¶åï¼ˆå«æ‰©å±•åï¼‰">
      <button class="btn-confirm" id="confirm">ç¡®å®š</button>
      <button class="btn-cancel" id="cancel">å–æ¶ˆ</button>
    </div>
  </div>

  <script>
    let createfile = document.querySelector('#createfile');
    let modal = document.querySelector('#modal');
    let confirmBtn = document.querySelector('#confirm');
    let cancelBtn = document.querySelector('#cancel');
    let filenameInput = document.querySelector('#filename');
    let save = document.querySelector('#save');
    let start = document.querySelector('#start');
    let openfolder = document.querySelector('#openfolder');
    let content = document.querySelector('.content');
    let coder = document.querySelector('#coder');
    let foldernameDiv = document.querySelector('#foldername');
    let fileDiv = document.querySelector('#file');
    let preBtn = document.querySelector('#pre');

    let currentFolder = null;
    let folderHistory = []; // To track folder history for back navigation
    let currentFileHandle = null; // To store the handle of the currently opened file

    const supportedExtensions = ['.html', '.css', '.js', '.jsx', '.py', '.java'];

    createfile.addEventListener('click', function () {
      modal.style.display = 'flex';
    });

    cancelBtn.addEventListener('click', function () {
      modal.style.display = 'none';
      filenameInput.value = '';
    });

    confirmBtn.addEventListener('click', async function () {
      let filename = filenameInput.value.trim();
      if (!filename) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ–‡ä»¶åï¼');
        return;
      }

      try {
        const handle = await window.showDirectoryPicker();
        const newFileHandle = await handle.getFileHandle(filename, { create: true });
        const writable = await newFileHandle.createWritable();
        await writable.write('è¿™æ˜¯æ–°æ–‡ä»¶çš„å†…å®¹');
        await writable.close();

        alert(`æ–‡ä»¶ "${filename}" å·²æˆåŠŸåˆ›å»ºï¼`);
        modal.style.display = 'none';
        filenameInput.value = '';
      } catch (err) {
        console.error(err);
        alert('ç”¨æˆ·å–æ¶ˆäº†æ“ä½œæˆ–ä¸æ”¯æŒæ–‡ä»¶ç³»ç»Ÿè®¿é—® APIã€‚');
      }
    });

    save.addEventListener('click', async function () {
      if (!currentFileHandle) {
        alert('æ²¡æœ‰é€‰æ‹©ä»»ä½•æ–‡ä»¶ï¼Œæ— æ³•ä¿å­˜ï¼');
        return;
      }

      try {
        const writable = await currentFileHandle.createWritable();
        await writable.write(coder.value);
        await writable.close();
        alert('æ–‡ä»¶å·²ä¿å­˜æˆåŠŸï¼');
      } catch (err) {
        console.error(err);
        alert('æ–‡ä»¶ä¿å­˜å¤±è´¥ï¼');
      }
    });

    start.addEventListener('click', async function () {
      if (!currentFileHandle) {
        alert('æ²¡æœ‰é€‰æ‹©ä»»ä½•æ–‡ä»¶ï¼Œè¯·å…ˆæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼');
        return;
      }

      const fileName = currentFileHandle.name;
      const fileExtension = fileName.slice(fileName.lastIndexOf('.')).toLowerCase();

      if (fileExtension === '.html') {
        try {
          const fileContent = coder.value;
          const blob = new Blob([fileContent], { type: 'text/html' });
          const url = URL.createObjectURL(blob);

          window.open(url, '_blank');
        } catch (err) {
          console.error(err);
          alert('è¿è¡Œæ–‡ä»¶æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•ï¼');
        }
      } else {
        alert('è¯·æ‰“å¼€ä¸€ä¸ª HTML æ–‡ä»¶è¿è¡Œï¼');
      }
    });

    openfolder.addEventListener('click', async function () {
      save.style.display = 'inline';
      start.style.display = 'inline';
      openfolder.style.display = 'none';

      try {
        const folderHandle = await window.showDirectoryPicker();
        currentFolder = folderHandle;
        folderHistory = [folderHandle];
        foldernameDiv.textContent = folderHandle.name;

        fileDiv.innerHTML = '';

        for await (const entry of folderHandle.values()) {
          const div = document.createElement('div');
          div.className = 'file-item';
          div.textContent = entry.name;

          if (entry.kind === 'directory') {
            div.addEventListener('dblclick', async function () {
              folderHistory.push(currentFolder);
              currentFolder = entry;
              foldernameDiv.textContent = currentFolder.name;
              loadFolderContent(currentFolder);
            });
          } else {
            div.addEventListener('dblclick', async function () {
              const fileName = entry.name;
              const fileExtension = fileName.slice(fileName.lastIndexOf('.')).toLowerCase();

              if (supportedExtensions.includes(fileExtension)) {
                try {
                  currentFileHandle = entry;
                  const file = await entry.getFile();
                  const fileContent = await file.text();
                  coder.value = fileContent;
                } catch (err) {
                  console.error(err);
                  alert('æ— æ³•è¯»å–æ–‡ä»¶å†…å®¹');
                }
              } else {
                alert('æ­¤æ–‡ä»¶ç±»å‹ä¸æ”¯æŒç¼–è¾‘');
              }
            });
          }

          fileDiv.appendChild(div);
        }
      } catch (err) {
        console.error(err);
        alert('æ— æ³•æ‰“å¼€æ–‡ä»¶å¤¹ã€‚');
      }
    });

    preBtn.addEventListener('click', function () {
      if (folderHistory.length > 1) {
        folderHistory.pop();
        currentFolder = folderHistory[folderHistory.length - 1];
        foldernameDiv.textContent = currentFolder.name;
        loadFolderContent(currentFolder);
      }
    });

    function loadFolderContent(folder) {
      fileDiv.innerHTML = '';
      (async () => {
        for await (const entry of folder.values()) {
          const div = document.createElement('div');
          div.className = 'file-item';
          div.textContent = entry.name;

          if (entry.kind === 'directory') {
            div.addEventListener('dblclick', async function () {
              folderHistory.push(currentFolder);
              currentFolder = entry;
              foldernameDiv.textContent = currentFolder.name;
              loadFolderContent(currentFolder);
            });
          } else {
            div.addEventListener('dblclick', async function () {
              const fileName = entry.name;
              const fileExtension = fileName.slice(fileName.lastIndexOf('.')).toLowerCase();

              if (supportedExtensions.includes(fileExtension)) {
                try {
                  currentFileHandle = entry;
                  const file = await entry.getFile();
                  const fileContent = await file.text();
                  coder.value = fileContent;
                } catch (err) {
                  console.error(err);
                  alert('æ— æ³•è¯»å–æ–‡ä»¶å†…å®¹');
                }
              } else {
                alert('æ­¤æ–‡ä»¶ç±»å‹ä¸æ”¯æŒç¼–è¾‘');
              }
            });
          }

          fileDiv.appendChild(div);
        }
      })();
    }

    alert('è¯·å‹¿åˆ·æ–°é¡µé¢ï¼Œç¦»å¼€æ—¶è¯·ä¿å­˜æ–‡ä»¶ï¼');
  </script>
</body>

</html>