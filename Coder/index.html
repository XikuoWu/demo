<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Coder</title>
  <link rel="shortcut icon" href="./favicon.ico" type="image/x-icon">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.js"></script>
  <script>
    if (!window.showDirectoryPicker) {
      alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒæ–‡ä»¶ç³»ç»Ÿè®¿é—® APIã€‚è¯·ä½¿ç”¨æ”¯æŒçš„æµè§ˆå™¨ï¼Œä¾‹å¦‚ Chrome æˆ– Edgeã€‚');
      return;
    }
    const invalidChars = /[\\/:*?"<>|]/;
    if (invalidChars.test(filename)) {
      alert('æ–‡ä»¶ååŒ…å«éæ³•å­—ç¬¦ï¼Œè¯·é‡æ–°è¾“å…¥ï¼');
      return;
    }
    const fragment = document.createDocumentFragment();
    for await (const entry of folder.values()) {
      const div = document.createElement('div');
      // å¤„ç†é€»è¾‘ç•¥
      fragment.appendChild(div);
    }
    fileDiv.appendChild(fragment);
    const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
    if (file.size > MAX_FILE_SIZE) {
      alert('æ–‡ä»¶è¿‡å¤§ï¼Œæ— æ³•åŠ è½½ï¼');
      return;
    }
    const languageMap = {
      '.html': 'html',
      '.css': 'css',
      '.js': 'javascript',
      '.jsx': 'javascript',
      '.py': 'python',
      '.java': 'java',
      '.less': 'less',
      '.scss': 'scss',
      '.ts': 'typescript',
      '.tsx': 'typescriptreact',
      '.json': 'json'
    };

    function setEditorLanguage(fileExtension) {
      const language = languageMap[fileExtension] || 'plaintext';
      monaco.editor.setModelLanguage(editor.getModel(), language);
    }

    async function safeExecute(action) {
      try {
        await action();
      } catch (err) {
        console.error(err);
        alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
      }
    }
    editorContainer.addEventListener('drop', async (event) => {
      event.preventDefault();
      const file = event.dataTransfer.files[0];
      if (file) {
        const text = await file.text();
        editor.setValue(text);
        setEditorLanguage(file.name.slice(file.name.lastIndexOf('.')));
      }
    });

    editorContainer.addEventListener('dragover', (event) => {
      event.preventDefault();
    });

    // æ–‡ä»¶ç®¡ç†æ¨¡å—
    const FileManager = {
      currentFolder: null,
      folderHistory: [],
      async loadFolderContent(folder) {
        fileDiv.innerHTML = '';
        for await (const entry of folder.values()) {
          const div = document.createElement('div');
          div.className = 'file-item';
          div.textContent = entry.name;

          if (entry.kind === 'directory') {
            div.addEventListener('dblclick', async () => {
              this.folderHistory.push(this.currentFolder);
              this.currentFolder = entry;
              foldernameDiv.textContent = this.currentFolder.name;
              await this.loadFolderContent(this.currentFolder);
            });
          } else {
            div.addEventListener('dblclick', () => FileManager.openFile(entry));
          }

          fileDiv.appendChild(div);
        }
      },
      async openFile(fileHandle) {
        try {
          const file = await fileHandle.getFile();
          const fileContent = await file.text();
          editor.setValue(fileContent);
          setEditorLanguage(fileHandle.name);
        } catch (err) {
          console.error('æ–‡ä»¶æ‰“å¼€å¤±è´¥', err);
          alert('æ— æ³•æ‰“å¼€æ–‡ä»¶');
        }
      },
    };

    async function loadFolderContent(folder) {
      const fragment = document.createDocumentFragment();
      for await (const entry of folder.values()) {
        const div = document.createElement('div');
        div.className = 'file-item';
        div.textContent = entry.name;

        if (entry.kind === 'directory') {
          div.addEventListener('dblclick', async () => {
            FileManager.folderHistory.push(FileManager.currentFolder);
            FileManager.currentFolder = entry;
            foldernameDiv.textContent = entry.name;
            await loadFolderContent(entry);
          });
        } else {
          div.addEventListener('dblclick', () => FileManager.openFile(entry));
        }

        fragment.appendChild(div);
      }
      fileDiv.innerHTML = '';
      fileDiv.appendChild(fragment);
    }
    // æ£€æŸ¥é”™è¯¯ä¿¡æ¯
    // é”™è¯¯æ£€æŸ¥é€»è¾‘
    async function validateCode() {
      const model = editor.getModel();
      const code = model.getValue();

      // ç¤ºä¾‹: ä½¿ç”¨ Monaco è‡ªå¸¦çš„ JavaScript æ£€æŸ¥å·¥å…·
      if (model.getModeId() === 'javascript') {
        const worker = await monaco.languages.typescript.getJavaScriptWorker();
        const client = await worker(model.uri);
        const diagnostics = await client.getSemanticDiagnostics(model.uri.toString());

        // æ¸…ç©ºæ—§çš„æ ‡è®°
        monaco.editor.setModelMarkers(model, 'owner', []);

        // æ·»åŠ æ–°æ ‡è®°
        const markers = diagnostics.map((diagnostic) => ({
          startLineNumber: diagnostic.start.line + 1,
          startColumn: diagnostic.start.character + 1,
          endLineNumber: diagnostic.end.line + 1,
          endColumn: diagnostic.end.character + 1,
          message: diagnostic.messageText,
          severity: monaco.MarkerSeverity.Error,
        }));

        monaco.editor.setModelMarkers(model, 'owner', markers);
      }
    }

    // ç›‘å¬ç¼–è¾‘å™¨å†…å®¹å˜åŒ–
    editor.onDidChangeModelContent(() => {
      validateCode();
    });
  </script>
  <style>
    body {
      padding: 0;
      margin: 0;
      background-color: rgb(50, 50, 50);
      color: white;
    }

    header {
      background-color: black;
      height: 50px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    header button {
      margin: 5px;
      background-color: white;
      border: 0;
      border-radius: 5px;
      padding: 3px;
      font-size: 13px;
      cursor: pointer;
      color: black;
    }

    textarea {
      background-color: #1e1e1e;
      color: #d4d4d4;
      font-family: Consolas, "Courier New", monospace;
      font-size: 14px;
      line-height: 1.5;
      caret-color: white;
      padding: 10px;
      border: none;
      outline: none;
      resize: none;
      box-shadow: none;
      overflow: auto;
    }

    textarea::selection {
      background-color: #264f78;
      color: white;
    }


    .content div {
      border-top: white 0.6px solid;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      display: none;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      width: 300px;
    }

    .modal-content input {
      width: 220px;
      padding: 10px;
      font-size: 16px;
    }

    .modal-content button {
      padding: 10px 15px;
      margin: 5px;
      font-size: 14px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
    }

    .btn-confirm {
      background-color: #4caf50;
      color: white;
    }

    .btn-cancel {
      background-color: #f44336;
      color: white;
    }

    #file {
      display: flex;
      margin-top: 10px;
      border: 0;
      margin-left: 10px;
    }

    .file-item {
      background-color: rgb(33, 33, 33);
      margin: 5px;
      padding: 10px;
      cursor: pointer;
      border-radius: 5px;
      width: 100px;
      border-top: 0;
      overflow: hidden;
    }

    .file-item:hover {
      background-color: rgb(60, 60, 60);
    }

    .monaco-editor .lines-content .view-line {
      border-bottom: none !important;
      border-top: none;
    }

    .monaco-editor .margin {
      background: none !important;
    }

    .monaco-editor .current-line {
      border: none !important;
    }

    .monaco-editor .view-line {
      line-height: normal !important;
      padding: 0 !important;
      margin: 0 !important;
      border: none !important;
    }

    #overlay {
      position: absolute;
      top: 123px;
      left: 0;
      width: 100%;
      height: 100vh;
      background: rgb(61, 61, 61);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 900;
    }

    #overlay img {
      height: 300px;
    }

    #selectlaunguage {
      font-size: 15px;
      padding: 1.8px;
      border-radius: 5px;
      background-color: white;
      color: black;
      margin: 5px;
    }
  </style>
</head>

<body>
  <header>
    <button id="save" style="background-color: rgb(212, 138, 86); display: none;">ä¿å­˜</button>
    <button id="createfile">åˆ›å»ºæ–‡ä»¶</button>
    <select name="" id="selectlaunguage">
      <option value="English" selected>English</option>
      <option value="Chinese">Chinese</option>
      <option value="France">France</option>
      <option value="German">German</option>
      <option value="Russian">Russian</option>
    </select>
    <button id="openfolder" style="font-size: 15px; padding: 3px;">æ‰“å¼€æ–‡ä»¶å¤¹</button>
    <button id="createfolder">åˆ›å»ºæ–‡ä»¶å¤¹</button>
    <button id="start" style="background-color: rgb(212, 138, 86); display: none;">è¿è¡Œ</button>
  </header>

  <div class="content">
    <div style="height: 70px; width: 100%; background-color: rgb(33, 33, 33); display: flex; overflow: auto;">
      <button
        style="margin: 10px; font-size: 30px; background-color: white; border: 0.3px black solid; border-radius: 6px; cursor: pointer; "
        id="pre">ğŸ”™</button>
      <div
        style="border: 0; display: inline; font-size: larger; margin-left: 10px; margin-top: 20px; border-right: 0.3px white solid; padding: 5px;"
        id="foldername">
      </div>
      <div id="file"></div>
    </div>
    <div id="editor-container" style="width: 100%; height: 100vh; border: 0;"></div>
  </div>

  <div class="modal" id="modal">
    <div class="modal-content">
      <h3 style="color: black;">è¾“å…¥æ–‡ä»¶å</h3>
      <input type="text" id="filename" placeholder="è¾“å…¥æ–‡ä»¶åï¼ˆå«æ‰©å±•åï¼‰">
      <button class="btn-confirm" id="confirm">ç¡®å®š</button>
      <button class="btn-cancel" id="cancel">å–æ¶ˆ</button>
    </div>
  </div>

  <div id="overlay" style="display: flex;">
    <img src="./favicon.ico" alt="Loading">
  </div>

  <script>
    let editor;

    // åˆå§‹åŒ– Monaco Editor
    require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs' } });
    require(['vs/editor/editor.main'], function () {
      monaco.editor.defineTheme('custom-dark', {
        base: 'vs-dark',
        inherit: true,
        rules: [],
        colors: {
          'editor.background': '#1e1e1e',
        }
      });

      // åˆå§‹åŒ–ç¼–è¾‘å™¨
      editor = monaco.editor.create(document.getElementById('editor-container'), {
        value: '<!-- Start coding HTML -->\n',
        language: 'html',
        theme: 'custom-dark',
        automaticLayout: true,
      });

      // å¯ç”¨ Emmet
      emmetMonaco.emmetHTML();

      // æ³¨å†Œ Tab é”®è¡¥å…¨åŠŸèƒ½
      editor.addCommand(monaco.KeyCode.Tab, function () {
        const model = editor.getModel();
        const position = editor.getPosition();
        const word = model.getWordAtPosition(position);
        if (word && word.word) {
          editor.trigger('keyboard', 'acceptSelectedSuggestion', {});
        }
      });
    });

    // åŠ¨æ€åˆ‡æ¢è¯­è¨€å‡½æ•°
    function setEditorLanguage(fileExtension) {
      let language;
      switch (fileExtension) {
        case '.html':
          language = 'html';
          break;
        case '.css':
          language = 'css';
          break;
        case '.js':
          language = 'javascript';
          break;
        case '.py':
          language = 'python';
          break;
        case '.java':
          language = 'java';
          break;
        case '.less':
          language = 'less';
          break;
        case '.scss':
          language = 'scss';
          break;
        case '.ts':
          language = 'typescript';
          break;
        case '.tsx':
          language = 'react';
          break;
        default:
          language = 'plaintext';
      }

      monaco.editor.setModelLanguage(editor.getModel(), language);
    }

    document.addEventListener("DOMContentLoaded", () => {
      // å®šä¹‰è¯­è¨€ç¿»è¯‘æ•°æ®
      const translations = {
        Chinese: {
          title: "ç¼–ç å™¨",
          save: "ä¿å­˜",
          createFile: "åˆ›å»ºæ–‡ä»¶",
          createFolder: "åˆ›å»ºæ–‡ä»¶å¤¹",
          run: "è¿è¡Œ",
          openFolder: "æ‰“å¼€æ–‡ä»¶å¤¹",
        },
        English: {
          title: "Coder",
          save: "Save",
          createFile: "Create File",
          createFolder: "Create Folder",
          run: "Run",
          openFolder: "Open Folder",
        },
        France: {
          title: "Programmeur",
          save: "Enregistrer",
          createFile: "CrÃ©er un fichier",
          createFolder: "CrÃ©er un dossier",
          run: "ExÃ©cuter",
          openFolder: "Ouvrir un dossier",
        },
        German: {
          title: "Programmierer",
          save: "Speichern",
          createFile: "Datei erstellen",
          createFolder: "Ordner erstellen",
          run: "AusfÃ¼hren",
          openFolder: "Ordner Ã¶ffnen",
        },
        Russian: {
          title: "ĞŸÑ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚",
          save: "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ",
          createFile: "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ»",
          createFolder: "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ğ°Ğ¿ĞºÑƒ",
          run: "Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ",
          openFolder: "ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¿Ğ°Ğ¿ĞºÑƒ",
        },
      };

      // åˆå§‹åŒ–é»˜è®¤è¯­è¨€ä¸º English
      const languageSelect = document.querySelector("#selectlaunguage");
      updateLanguage("English");

      // ç›‘å¬è¯­è¨€åˆ‡æ¢
      languageSelect.addEventListener("change", (event) => {
        const selectedLanguage = event.target.value;
        updateLanguage(selectedLanguage);
      });

      // æ›´æ–°é¡µé¢å†…å®¹çš„å‡½æ•°
      function updateLanguage(language) {
        const langData = translations[language];
        if (!langData) {
          console.warn(`è¯­è¨€ ${language} ä¸å­˜åœ¨`);
          return;
        }

        // æ›´æ–°é¡µé¢æ ‡é¢˜
        document.title = langData.title;

        // æ›´æ–°æŒ‰é’®æ–‡æœ¬
        document.querySelector("#save").textContent = langData.save;
        document.querySelector("#createfile").textContent = langData.createFile;
        document.querySelector("#createfolder").textContent = langData.createFolder;
        document.querySelector("#start").textContent = langData.run;
        document.querySelector("#openfolder").textContent = langData.openFolder;
      }
    });


    let createfile = document.querySelector('#createfile');
    let modal = document.querySelector('#modal');
    let confirmBtn = document.querySelector('#confirm');
    let cancelBtn = document.querySelector('#cancel');
    let filenameInput = document.querySelector('#filename');
    let save = document.querySelector('#save');
    let start = document.querySelector('#start');
    let openfolder = document.querySelector('#openfolder');
    let content = document.querySelector('.content');
    let coder = document.querySelector('#coder');
    let foldernameDiv = document.querySelector('#foldername');
    let fileDiv = document.querySelector('#file');
    let preBtn = document.querySelector('#pre');
    let createfolder = document.querySelector('#createfolder');

    let currentFolder = null;
    let folderHistory = [];
    let currentFileHandle = null;

    const supportedExtensions = ['.html', '.css', '.js', '.jsx', '.py', '.java', '.less', '.scss', '.ts', '.tsx'];

    // æ‰“å¼€æ–‡ä»¶å¤¹
    openfolder.addEventListener('click', async function () {
      save.style.display = 'inline';
      start.style.display = 'inline';
      openfolder.style.display = 'none';

      try {
        const folderHandle = await window.showDirectoryPicker();
        currentFolder = folderHandle;
        folderHistory = [folderHandle];
        foldernameDiv.textContent = folderHandle.name;

        loadFolderContent(currentFolder);
      } catch (err) {
        console.error(err);
        alert('æ— æ³•æ‰“å¼€æ–‡ä»¶å¤¹ã€‚');
      }
    });

    // åˆ›å»ºæ–‡ä»¶
    createfile.addEventListener('click', function () {
      modal.style.display = 'flex';
    });

    cancelBtn.addEventListener('click', function () {
      modal.style.display = 'none';
      filenameInput.value = '';
    });

    confirmBtn.addEventListener('click', async function () {
      let filename = filenameInput.value.trim();
      if (!filename) {
        alert('please entre a effective valueï¼');
        return;
      }

      if (!currentFolder) {
        alert('Please open a open a folder firstï¼');
        return;
      }

      try {
        // å¦‚æœæ˜¯ .html æ–‡ä»¶ï¼Œå†™å…¥åŸºç¡€ HTML æ¨¡æ¿
        let fileContent = '';
        if (filename.endsWith('.html')) {
          fileContent = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <div class=""></div>
</body>
</html>`;
        }

        // åˆ›å»ºæ–‡ä»¶
        const newFileHandle = await currentFolder.getFileHandle(filename, { create: true });

        // å†™å…¥æ–‡ä»¶å†…å®¹
        const writable = await newFileHandle.createWritable();
        await writable.write(fileContent);
        await writable.close();

        alert(`file "${filename}" is created sucsessfulyï¼`);
        modal.style.display = 'none';
        filenameInput.value = '';

        loadFolderContent(currentFolder); // åˆ·æ–°æ–‡ä»¶å¤¹å†…å®¹
      } catch (err) {
        console.error(err);
      }
    });


    // åˆ›å»ºæ–‡ä»¶å¤¹
    // åˆ›å»ºæ–‡ä»¶å¤¹
    createfolder.addEventListener('click', async function () {
      try {
        if (!currentFolder) {
          alert('Please open a open a folder firstï¼');
          return;
        }

        const folderName = prompt('please entre a effective value:');
        if (!folderName) {
          alert('please entre a effective valueï¼');
          return;
        }

        // åœ¨å½“å‰æ–‡ä»¶å¤¹ä¸­åˆ›å»ºæ–°æ–‡ä»¶å¤¹
        await currentFolder.getDirectoryHandle(folderName, { create: true });
        alert(`Folder "${folderName}" is created succsesfully`);

        // åˆ·æ–°å½“å‰æ–‡ä»¶å¤¹å†…å®¹
        loadFolderContent(currentFolder);
      } catch (err) {
        console.error(err);
      }
    });



    // ä¿å­˜æ–‡ä»¶
    save.addEventListener('click', async function () {
      if (!currentFileHandle) {
        alert('can not save');
        return;
      }

      try {
        // è·å–æ–‡ä»¶çš„å¯å†™æµ
        const writable = await currentFileHandle.createWritable();

        // å†™å…¥ç¼–è¾‘å™¨çš„å†…å®¹
        await writable.write(editor.getValue());

        // å…³é—­å†™å…¥æµ
        await writable.close();

        alert('file saved sucsessfully');
      } catch (err) {
        console.error('æ–‡ä»¶ä¿å­˜å¤±è´¥ï¼š', err);

        // é’ˆå¯¹ä¸åŒç±»å‹çš„é”™è¯¯æä¾›å…·ä½“æç¤º
        if (err.name === 'NotAllowedError') {
          alert('ä¿å­˜å¤±è´¥ï¼šç”¨æˆ·æœªæˆäºˆå†™å…¥æƒé™ã€‚');
        } else {
          alert(`ä¿å­˜å¤±è´¥ï¼š${err.message}`);
        }
      }
    });


    // è¿è¡Œæ–‡ä»¶
    start.addEventListener('click', async function () {
      if (!currentFileHandle) {
        alert('please open a file first');
        return;
      }

      const fileName = currentFileHandle.name;
      const fileExtension = fileName.slice(fileName.lastIndexOf('.')).toLowerCase();

      if (fileExtension === '.html') {
        try {
          // è·å–ç¼–è¾‘å™¨å†…å®¹
          const fileContent = editor.getValue();
          if (!fileContent.trim()) {
            alert('the file is empty');
            return;
          }

          // åˆ›å»º Blob å¹¶ç”Ÿæˆ URL
          const blob = new Blob([fileContent], { type: 'text/html' });
          const url = URL.createObjectURL(blob);

          // æ‰“å¼€æ–°çª—å£è¿è¡Œæ–‡ä»¶
          window.open(url, '_blank');
        } catch (err) {
          console.error('è¿è¡Œæ–‡ä»¶æ—¶å‡ºé”™ï¼š', err);
          alert('can not run');
        }
      } else {
        alert('can on ly run html files');
      }
    });


    // è¿”å›ä¸Šä¸€çº§æ–‡ä»¶å¤¹
    preBtn.addEventListener('click', function () {
      if (folderHistory.length > 1) {
        folderHistory.pop();
        currentFolder = folderHistory[folderHistory.length - 1];
        foldernameDiv.textContent = currentFolder.name;
        loadFolderContent(currentFolder);
      }
    });

    // åŠ è½½æ–‡ä»¶å¤¹å†…å®¹
    async function loadFolderContent(folder) {
      fileDiv.innerHTML = '';
      for await (const entry of folder.values()) {
        const div = document.createElement('div');
        div.className = 'file-item';
        div.textContent = entry.name;

        if (entry.kind === 'directory') {
          div.addEventListener('dblclick', async function () {
            folderHistory.push(currentFolder);
            currentFolder = entry;
            foldernameDiv.textContent = currentFolder.name;
            loadFolderContent(currentFolder);
          });
        } else {
          div.addEventListener('dblclick', async function () {
            const fileName = entry.name;
            const fileExtension = fileName.slice(fileName.lastIndexOf('.')).toLowerCase();
            overlay.style.display = 'none'

            if (supportedExtensions.includes(fileExtension)) {
              try {
                currentFileHandle = entry; // ä¿å­˜å½“å‰æ–‡ä»¶å¥æŸ„
                const file = await entry.getFile(); // è·å–æ–‡ä»¶
                const fileContent = await file.text(); // è¯»å–æ–‡ä»¶å†…å®¹

                // åŠ è½½æ–‡ä»¶å†…å®¹åˆ°ç¼–è¾‘å™¨
                editor.setValue(fileContent);

                // æ ¹æ®æ–‡ä»¶æ‰©å±•åè®¾ç½®è¯­è¨€
                setEditorLanguage(fileExtension);
              } catch (err) {
                console.error('è¯»å–æ–‡ä»¶å†…å®¹æ—¶å‡ºé”™ï¼š', err);
                alert(`can not read fileï¼š${err.message}`);
              }
            } else {

            }
          });
        }

        fileDiv.appendChild(div);
      }
    }

    alert('Please do not refresh the page and save the file before leaving!');
  </script>
</body>

</html>